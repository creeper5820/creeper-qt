name: 📦 Nightly Build Library

on:
  schedule:
  - cron: '0 0 * * *'
  workflow_dispatch:


jobs:
  build-linux:
    runs-on: ubuntu-latest
    name: Build on Linux

    outputs:
      artifact-name: linux-artifacts

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Prepare release folder
      run: mkdir -p ${{ github.workspace }}/release/

    - name: Build Arch Linux package with makepkg in Docker
      uses: docker://archlinux/archlinux:latest
      with:
        args: |
          /bin/bash -c "
            set -e
            pacman -Sy --noconfirm sudo git fakeroot debugedit gcc cmake make qt6-base eigen
            useradd -m builder && echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
            chown -R builder:builder /github/workspace/export/archlinux/
            su builder -c '
              cd /github/workspace/export/archlinux/
              makepkg -sfc --noconfirm
            '
            cd /github/workspace/export/archlinux/
            rm creeper-qt-git-debug-*.pkg.tar.zst || true
            mv creeper-qt-git-*.pkg.tar.zst /github/workspace/release/creeper-qt-linux-x86_64.pkg.tar.zst
          "

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y qt6-base-dev libeigen3-dev cmake g++-14
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100 --slave /usr/bin/g++ g++ /usr/bin/g++-14
        sudo update-alternatives --config gcc

    - name: Configure and build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build -j

    - name: Package with CPack
      run: |
        cd build
        cpack -G DEB
        cp *.deb ../release/creeper-qt-linux-x86_64.deb

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-artifacts
        path: release/*

  publish-release:
    name: Publish Release
    needs: build-linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download Linux Artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-artifacts
        path: release/

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: nightly-library
        name: "🛠️ creeper-qt — Nightly Build"
        body: |
          🛠️ 自动构建的 **creeper-qt** 库包，适用于 Linux 系统。

          每日自动更新，便于测试和集成最新功能。包含两种格式：

          **📦 Debian (.deb) 安装包**
          - 文件名：`creeper-qt-x86_64.deb`
          - 适用于 Debian/Ubuntu 系列发行版
          - 安装方式：`sudo apt install creeper-qt-*.deb`

          **📦 Arch Linux (.pkg.tar.zst) 包**
          - 文件名：`creeper-qt-x86_64.pkg.tar.zst`
          - 适用于 Arch Linux 系列发行版
          - 安装方式：`sudo pacman -U creeper-qt-*.pkg.tar.zst`

          **📦 Windows (...) 包**
          - TODO (未来将支持 Windows 构建)

          ⚠️ 本构建为预发布版本，仅供测试使用。如需稳定版本，请参考正式发布页。
        files: release/*
        prerelease: true
        update_release_body: true
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
