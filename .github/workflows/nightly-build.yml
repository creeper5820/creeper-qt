name: ğŸ“¦ Nightly Build Library

on:
  schedule:
  - cron: '0 0 * * *'
  workflow_dispatch:


jobs:
  build-linux:
    runs-on: ubuntu-latest
    name: Build on Linux

    outputs:
      artifact-name: linux-artifacts

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Prepare release folder
      run: mkdir -p ${{ github.workspace }}/release/

    - name: Build Arch Linux package with makepkg in Docker
      uses: docker://archlinux/archlinux:latest
      with:
        args: |
          /bin/bash -c "
            set -e
            pacman -Sy --noconfirm sudo git fakeroot debugedit gcc cmake make qt6-base eigen
            useradd -m builder && echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
            chown -R builder:builder /github/workspace/export/archlinux/
            su builder -c '
              cd /github/workspace/export/archlinux/
              makepkg -sfc --noconfirm
            '
            cd /github/workspace/export/archlinux/
            rm creeper-qt-git-debug-*.pkg.tar.zst || true
            mv creeper-qt-git-*.pkg.tar.zst /github/workspace/release/creeper-qt-linux-x86_64.pkg.tar.zst
          "

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y qt6-base-dev libeigen3-dev cmake g++-14
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100 --slave /usr/bin/g++ g++ /usr/bin/g++-14
        sudo update-alternatives --config gcc

    - name: Configure and build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build -j

    - name: Package with CPack
      run: |
        cd build
        cpack -G DEB
        cp *.deb ../release/creeper-qt-linux-x86_64.deb

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-artifacts
        path: release/*

  publish-release:
    name: Publish Release
    needs: build-linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download Linux Artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-artifacts
        path: release/

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: nightly-library
        name: "ğŸ› ï¸ creeper-qt â€” Nightly Build"
        body: |
          ğŸ› ï¸ è‡ªåŠ¨æ„å»ºçš„ **creeper-qt** åº“åŒ…ï¼Œé€‚ç”¨äº Linux ç³»ç»Ÿã€‚

          æ¯æ—¥è‡ªåŠ¨æ›´æ–°ï¼Œä¾¿äºæµ‹è¯•å’Œé›†æˆæœ€æ–°åŠŸèƒ½ã€‚åŒ…å«ä¸¤ç§æ ¼å¼ï¼š

          **ğŸ“¦ Debian (.deb) å®‰è£…åŒ…**
          - æ–‡ä»¶åï¼š`creeper-qt-x86_64.deb`
          - é€‚ç”¨äº Debian/Ubuntu ç³»åˆ—å‘è¡Œç‰ˆ
          - å®‰è£…æ–¹å¼ï¼š`sudo apt install creeper-qt-*.deb`

          **ğŸ“¦ Arch Linux (.pkg.tar.zst) åŒ…**
          - æ–‡ä»¶åï¼š`creeper-qt-x86_64.pkg.tar.zst`
          - é€‚ç”¨äº Arch Linux ç³»åˆ—å‘è¡Œç‰ˆ
          - å®‰è£…æ–¹å¼ï¼š`sudo pacman -U creeper-qt-*.pkg.tar.zst`

          **ğŸ“¦ Windows (...) åŒ…**
          - TODO (æœªæ¥å°†æ”¯æŒ Windows æ„å»º)

          âš ï¸ æœ¬æ„å»ºä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨ã€‚å¦‚éœ€ç¨³å®šç‰ˆæœ¬ï¼Œè¯·å‚è€ƒæ­£å¼å‘å¸ƒé¡µã€‚
        files: release/*
        prerelease: true
        update_release_body: true
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
